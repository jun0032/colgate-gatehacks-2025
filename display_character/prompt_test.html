<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Image Analysis</title>
  </head>
  <body>
    <h1>Gemini Image Analysis</h1>

    <input
      type="text"
      id="apiKey"
      placeholder="Enter your Gemini API key"
      size="50"
    />
    <br /><br />

    <input type="file" id="imageInput" accept="image/*" />
    <br /><br />

    <img id="preview" width="400" />
    <br /><br />

    <button id="analyzeBtn">Analyze Image</button>
    <br /><br />

    <div id="response"></div>

    <script>
      let previousResponse = "";
      let currentImageBase64 = "";

      document
        .getElementById("imageInput")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              document.getElementById("preview").src = event.target.result;
              currentImageBase64 = event.target.result.split(",")[1];
            };
            reader.readAsDataURL(file);
          }
        });

      document
        .getElementById("analyzeBtn")
        .addEventListener("click", async function () {
          const apiKey = document.getElementById("apiKey").value;

          if (!apiKey) {
            alert("Please enter your Gemini API key");
            return;
          }

          if (!currentImageBase64) {
            alert("Please select an image first");
            return;
          }

          const prompt = `You have previously replied "${previousResponse}" Make your next response unique.
INSTRUCTIONS: You are the ultra-duper super kawaii character in the top left. Provide commentary based on the contents of this image. Keep your response minimal, and under 200 characters. Anything exceeding 200 characters will be truncated`;

          try {
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        { text: prompt },
                        {
                          inline_data: {
                            mime_type: "image/jpeg",
                            data: currentImageBase64,
                          },
                        },
                      ],
                    },
                  ],
                }),
              }
            );

            const data = await response.json();

            if (data.error) {
              document.getElementById("response").textContent =
                "Error: " + data.error.message;
              return;
            }

            const text = data.candidates[0].content.parts[0].text;
            const truncated = text.substring(0, 200);

            previousResponse = truncated;
            document.getElementById("response").textContent = truncated;
          } catch (error) {
            document.getElementById("response").textContent =
              "Error: " + error.message;
          }
        });
    </script>
  </body>
</html>
